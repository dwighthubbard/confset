#!/usr/bin/env python
import sys
import os
import shutil
import time
import logging
CONF_PATH=['/etc/default']

def usage():
  print 'confset conffile.parameter=value'
  sys.exit(1)
 
def search_for_conf(conffile):
  global CONF_PATH
  filename=None
  for dir in CONF_PATH:
    filename=os.path.join(dir,conffile)
    if os.path.isfile(filename):
      break
    else: 
      filename=None
  return filename

def available_settings(conffile,filter=None,help=False):
  filename=search_for_conf(conffile)
  comments=[]
  if filename:
    fh=open(filename,'r')
    for line in fh.readlines():
      line=line.strip()
      if line:
        if line.startswith('#'):
          comments.append(line.strip('#'))
        else:
          if '=' in line:
            if not filter or line.split('=')[0] == filter:
              setting='%s.%s' % (conffile,line.split('=')[0])
              print '%s%s' % (setting,' - '+comments[0] if comments else "")
              if help and len(comments) > 1:
                print (' '*(len(setting)+3)).join(comments[1:])
            comments=[]
      else:
        comments=[]
        
args=''.join(sys.argv[1:])

if args:
  if '.' not in args:
    available_settings(args)
  else:
    conffile=args.split('.')[0]
    filter=args.split('.')[1]
    available_settings(conffile,filter,help=True)
  sys.exit(0)

if '.' not in args:
  usage()
      
conffile=args.split('.')[0]
key=''.join(args.split('.')[1:]).split('=')[0].strip()
value=''.join(args.split('.')[1:]).split('=')[1].strip()
filename=search_for_conf(conffile)

if filename:
  shutil.copy(filename,'%s.confset.%s' % (filename,time.strftime("%Y%m%d%H%M%S")))
  data=open(filename,'r').readlines()
  changed=False    
  if '=' in args:
    fh=open(filename,'w')
    for line in data:
      if not line.strip().startswith('#') and '=' in line:
        tkey=line.strip().split('=')[0].strip()
        tvalue=line.strip().split('=')[1].strip()
        if key == tkey:
          line='%s=%s\n' % (key,value) 
          changed=True
      fh.write(line)
    if changed == False:
      fh.write('%s=%s\n' % (key,value))
    fh.close()
    