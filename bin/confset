#!/usr/bin/env python
import sys
import os
import shutil
import time
import logging
CONF_PATH=['/etc/default']

def usage():
  print 'confset conffile.parameter=value'
  sys.exit(1)
  
args=''.join(sys.argv[1:])

if '.' not in args:
  usage()
  
conffile=args.split('.')[0]
key=''.join(args.split('.')[1:]).split('=')[0].strip()
value=''.join(args.split('.')[1:]).split('=')[1].strip()
filename=None
for dir in CONF_PATH:
  filename=os.path.join(dir,conffile)
  if os.path.isfile(filename):
    break

if filename:
  shutil.copy(filename,'%s.confset.%s' % (filename,time.strftime("%Y%m%d%H%M%S")))
  data=open(filename,'r').readlines()
  changed=False    
  if '=' in args:
    fh=open(filename,'w')
    for line in data:
      if not line.strip().startswith('#') and '=' in line:
        tkey=line.strip().split('=')[0].strip()
        tvalue=line.strip().split('=')[1].strip()
        if key == tkey:
          line='%s=%s\n' % (key,value) 
          changed=True
      fh.write(line)
    if changed == False:
      fh.write('%s=%s\n' % (key,value))
    fh.close()
    